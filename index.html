<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>判定テスト</title>
<style>
    body { text-align:center; font-family:sans-serif; padding-top: 50px; }
    img { max-width:90%; max-height:60vh; border: 1px solid #ccc; margin: 10px 0; }
    button { font-size:24px; margin:10px; padding:10px 30px; cursor: pointer; border-radius: 8px; }
    input { font-size:18px; padding:10px; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
    #quiz-container { display: none; } /* 最初は隠す */
</style>
</head>

<body>

<div id="setup-container">
    <h2>判定テスト</h2>
    <div style="margin-bottom: 20px;">
        <input id="username" placeholder="名前を入力してください">
    </div>
    <button onclick="startQuiz()">テスト開始</button>
</div>

<div id="quiz-container">
    <h2 id="counter"></h2>
    <img id="img"><br>
    <div>
        <button onclick="answer('distal')">distal</button>
        <button onclick="answer('mesial')">mesial</button>
    </div>
</div>

<script>
// ===== 問題生成（40枚）=====
const problems = [];
["1distal","1mesial","2distal","2mesial"].forEach(type=>{
  for(let i = 1; i <= 10; i++){
    problems.push({
      file: `github-dental/${type} (${i}).jpg`,
      correct: type.includes("distal") ? "distal" : "mesial"
    });
  }
});

// ===== 変数管理 =====
const shuffled = [...problems].sort(() => Math.random() - 0.5);
const questions = shuffled.slice(0, 20); // 20問選出
let index = 0;
let score = 0;
const answers = [];

// ===== 1. テスト開始ボタンの処理 =====
function startQuiz() {
    const name = document.getElementById("username").value.trim();
    if(!name) {
        alert("名前を入力してから開始してください");
        return;
    }
    // 表示の切り替え
    document.getElementById("setup-container").style.display = "none";
    document.getElementById("quiz-container").style.display = "block";
    show();
}

// ===== 2. 問題の表示 =====
function show(){
    document.getElementById("counter").textContent =
      `問題 ${index + 1} / ${questions.length}`;

    document.getElementById("img").src = questions[index].file;
}

// ===== 3. 回答ボタンの処理 =====
function answer(a){
    const q = questions[index];
    const correctFlag = (a === q.correct) ? 1 : 0;

    if(correctFlag) score++;

    // 回答データを配列に保存
    answers.push(`${q.file}:${a}:${q.correct}:${correctFlag}`);

    index++;

    if(index >= questions.length){
        finish();
        return;
    }

    show();
}

// ===== 4. 終了・送信処理 =====
function finish(){
    const name = document.getElementById("username").value;
    
    // 名名を先頭に、回答データを後ろにくっつける（新しい列を作らない）
    const combinedData = `${name},${answers.join(",")}`;

    // GASへ送信
    fetch("https://script.google.com/macros/s/AKfycbwHCsoQaIbzWGPd5Ft8dAHVV4EWoJwPHtyB5i6rdQWZiqREAjQJsmIw4TgW3-M18GmU/exec", {
        method: "POST",
        mode: "no-cors",
        body: new URLSearchParams({
            data: combinedData // すべて「data」という1つの項目で送る
        })
    });

    // 画面の最終表示
    document.body.innerHTML =
      `<div style="margin-top:50px;">
          <h2>終了</h2>
          <p><strong>${name}</strong> さん</p>
          <p>正答数：${score} / ${questions.length}</p>
          <p>結果を送信しました。</p>
          <button onclick="location.reload()">もう一度受ける</button>
       </div>`;
}
</script>

</body>
</html>
